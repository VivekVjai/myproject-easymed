{% extends 'base.html' %} {% load static %} {%block main_block%}

<!-- Checkout Container -->
<div class="max-w-2xl mx-auto mt-10 bg-white p-8 rounded-lg shadow-lg">
  <h2 class="text-3xl font-bold text-indigo-700 mb-6">Confirm & Pay</h2>

  <!-- Order Summary -->
  <div class="bg-gray-50 p-4 rounded border mb-6">
    <h3 class="text-lg font-semibold mb-2">ðŸ§¾ Order Summary</h3>
    <p class="text-gray-600">
      <strong>Email:</strong> {{ request.user.email }}
    </p>
    <p class="text-gray-600">
      <strong>Order ID:</strong> {{ razorpay_order_id }}
    </p>
    <p class="text-gray-800 text-xl font-bold mt-4">
      Total: â‚¹{{ amount|floatformat:2 }}
    </p>
  </div>
  <hr class="my-4" />

  {% for item in cart_items %}
  <div class="flex justify-between items-center mb-2 text-sm text-gray-700">
    <div>
      <p class="font-semibold">{{ item.medicine_object.name }}</p>
      <p class="text-xs text-gray-500">Quantity: {{ item.quantity }}</p>
      <p class="text-xs text-gray-500">
        Unit Price: â‚¹{{ item.discounted_price }}
      </p>
    </div>
    <div class="font-bold text-right">â‚¹{{ item.total_price }}</div>
  </div>
  {% endfor %}

  <hr class="my-4" />
  <p class="text-lg font-semibold text-indigo-700 text-right">
    ðŸ§¾ Total Payable: â‚¹{{ amount|floatformat:2 }}
  </p>

  <!-- Payment Button -->
  <div class="text-center">
    <button
      id="pay-btn"
      class="w-full bg-green-500 hover:bg-green-600 text-white text-lg font-semibold py-3 px-6 rounded-lg transition"
      type="submit"
    >
      ðŸ’³ Pay â‚¹{{ amount|floatformat:2 }} Now
    </button>
  </div>
</div>

<!-- Razorpay Script -->

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
  const options = {
    key: "{{ razorpay_key }}",
    amount: "{{ amount|floatformat:0|stringformat:'d' }}00", // Razorpay needs amount in paise
    currency: "INR",
    name: "MedApp",
    description: "Medicine Order",
    order_id: "{{ razorpay_order_id }}",
    handler: function (response) {
      document.getElementById("razorpay_payment_id").value =
        response.razorpay_payment_id;
      document.getElementById("razorpay_order_id").value =
        response.razorpay_order_id;
      document.getElementById("razorpay_signature").value =
        response.razorpay_signature;
      document.getElementById("payment-form").submit();
    },
    prefill: {
      name: "{{ request.user.get_full_name|default:request.user.username }}",
      email: "{{ request.user.email }}",
    },
    theme: {
      color: "#4f46e5",
    },
  };

  const rzp1 = new Razorpay(options);
  document.getElementById("pay-btn").onclick = function (e) {
    rzp1.open();
    e.preventDefault();
  };
</script>

<form
  id="payment-form"
  action="{% url 'payment' %}"
  method="POST"
  style="display: none"
>
  {% csrf_token %}
  <input type="hidden" name="razorpay_payment_id" id="razorpay_payment_id" />
  <input type="hidden" name="razorpay_order_id" id="razorpay_order_id" />
  <input type="hidden" name="razorpay_signature" id="razorpay_signature" />
</form>

{%endblock%}
